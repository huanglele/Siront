<!-- InputMask -->
<script src="__PUBLIC__/js/plugins/input-mask/jquery.inputmask.js" type="text/javascript"></script>
<script src="__PUBLIC__/js/plugins/input-mask/jquery.inputmask.date.extensions.js" type="text/javascript"></script>
<script src="__PUBLIC__/js/plugins/input-mask/jquery.inputmask.extensions.js" type="text/javascript"></script>

<!-- Content Header (Page header) -->
<section class="content-header">
    <h1>
        用户管理
        <small>添加企业用户</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="<{:U('index/index')}>"><i class="fa fa-dashboard"></i> 首页</a></li>
        <li><a href="<{:U('user/user')}>">添加企业用户</a></li>
    </ol>
</section>

<section class="content">
    <div class="row">
        <div class="col-md-8 col-md-offset-2">

            <div>
                <!--添加企业用户表单-->
                <form action="<{:U('user/addCompany')}>" method="post" enctype="multipart/form-data" >
                    <!--表单导航信息-->
                    <ul class="nav nav-tabs" role="tablist">
                        <li role="presentation" class="active">
                            <a href="#infoForm" aria-controls="infoForm" role="tab" data-toggle="tab">基本信息</a>
                        </li>
                        <li role="presentation">
                            <a href="#companyForm" aria-controls="companyForm" role="tab" data-toggle="tab">企业信息</a>
                        </li>
                        <li role="presentation">
                            <a href="#catForm" aria-controls="catForm" role="tab" data-toggle="tab">行业信息</a>
                        </li>
                        <li class="pull-right">
                            <button name="submit" type="submit" class="btn btn-danger">提交</button>
                        </li>
                    </ul>
                    <!--表单信息-->
                    <div class="tab-content">
                        <!--基本信息-->
                        <div  role="tabpanel" id="infoForm" class="active tab-pane box box-danger">
                            <div class="box-header">
                                <h3 class="box-title">基本信息</h3>
                            </div>
                            <div class="box-body">
                                <div class="form-group">
                                    <label>手机号</label>
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <i class="fa fa-mobile-phone"></i>
                                        </div>
                                        <input type="text" name="phone" data-inputmask="'mask': ['999-9999-9999', '+099 99 99 9999[9]-9999'], 'greedy' : false" class="form-control"  data-mask="">
                                        <div class="input-group-addon">
                                            <i class="fa bg-red fa-asterisk"></i>
                                        </div>
                                    </div><!-- /.input group -->
                                </div><!-- /.form group -->

                                <div class="form-group">
                                    <label>昵称</label>
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <i class="fa fa-user"></i>
                                        </div>
                                        <input type="text" name="nickname" class="form-control" data-inputmask="'mask':'9', 'repeat': 10, 'greedy': false" data-mask="">
                                        <div class="input-group-addon">
                                            <i class="fa bg-red fa-asterisk"></i>
                                        </div>
                                    </div><!-- /.input group -->
                                </div><!-- /.form group -->

                                <div class="form-group">
                                    <label>密码</label>
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <i class="fa fa-dot-circle-o"></i>
                                        </div>
                                        <input type="text" name="password" class="form-control" >
                                        <div class="input-group-addon">
                                            <i class="fa bg-red fa-asterisk"></i>
                                        </div>
                                    </div><!-- /.input group -->
                                </div><!-- /.form group -->

                            </div><!-- /.box-body -->
                        </div><!-- /.box -->

                        <!--企业信息-->
                        <div  role="tabpanel" id="companyForm"  class="tab-pane box box-info">
                            <div class="box-header">
                                <h3 class="box-title">企业信息</h3>
                            </div>
                            <div class="box-body">

                                <!--设置企业地址 -->
                                <div class="form-group">
                                    <label>设置企业地址</label>
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <i class="fa fa-map-marker"></i>
                                        </div>
                                        <input type="text" name="place" class="form-control" >
                                        <input type="hidden" name="lon">
                                        <input type="hidden" name="lat">
                                        <div class="input-group-btn">
                                            <button role="button" class="btn btn-info" id="chooseMapBtn" >选择</button>
                                        </div>
                                    </div>
                                </div><!-- /.form group -->

                                <!--公司联系方式-->
                                <div class="form-group">
                                    <label>公司联系方式</label>
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <i class="fa fa-phone"></i>
                                        </div>
                                        <input type="text" name="tel" class="form-control">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>法人身份证</label>
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <i class="fa fa-credit-card"></i>
                                        </div>
                                        <input type="file" name="sfz" class="form-control">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>企业营业执照</label>
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <i class="fa fa-picture-o"></i>
                                        </div>
                                        <input type="file" name="license" class="form-control">
                                    </div>
                                </div>

                            </div><!-- /.box-body -->
                        </div><!-- /.box -->

                        <!--行业信息-->
                        <div  role="tabpanel" id="catForm"  class="tab-pane box box-primary">
                            <div class="box-header">
                                <h3>选择行业</h3>
                            </div>
                            <div class="box-body">
                                <div>
                                    <!-- Nav tabs -->
                                    <ul class="nav nav-tabs" role="tablist">
                                        <volist name="catMenuF" id="v">
                                            <li role="presentation"><a href="#catmenu<{$v.id}>" disabled title="nihoa" aria-controls="catmenu<{$v.id}>" role="tab" data-toggle="tab"><{$v.name}></a></li>
                                        </volist>
                                    </ul>

                                    <!-- Tab panes -->
                                    <div class="tab-content">
                                        <volist name="catMenuS" id="vo">
                                            <div role="tabpanel" style="position: relative;" class="tab-pane row" id="catmenu<{$key}>" <eq name="catMenuF[$key]['status']" value="0">title='该分类未启用'</eq>>
                                            <eq name="catMenuF[$key]['status']" value="0">
                                                <div class="con-disabled"></div>
                                                <div class="con-disabled-img"></div>
                                            </eq>
                                                <volist name="vo" id="v">
                                                    <div class="col-sm-4">
                                                        <div class="checkbox">
                                                            <label>
                                                                <input type="checkbox" <eq name="v.status" value="0">disabled alt='未启用'</eq>  name="tags[]" value="<{$v.id}>" class=""/>
                                                                <{$v.name}>
                                                            </label>
                                                        </div>
                                                    </div>

                                                </volist>
                                            </div>
                                        </volist>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

        </div>
    </div>
</section>

<!-- Page script -->
<script type="text/javascript">

    function aMap(){
        var lon = 116.397428;
        var lat = 39.90923;
        var marker = null;
        var map = null;
        var container = 'container';
        this.setLon = function(lon){
            lon = lon;
        }
        this.setLat = function(lat){
            lat = lat;
        }
        this.setContainer = function(con){
            container = con;
        }

        var auto = new AMap.Autocomplete({
            input: "tipinput"
        });

        this.init = function(){
            map = new AMap.Map(container, {
                resizeEnable: true,
                zoom: 13
            });
            //地图中添加地图操作ToolBar插件
            map.plugin(['AMap.ToolBar'], function() {
                //设置地位标记为自定义标记
                var toolBar = new AMap.ToolBar();
                map.addControl(toolBar);
            });
            map.on('click', function(e) { //为地图注册click事件获取鼠标点击出的经纬度坐标
                if(!marker){
                    lon = e.lnglat.getLng();
                    lat = e.lnglat.getLat();
                    addMark();
                }
            })

            AMap.event.addListener(auto, "select", select);//注册监听，当选中某条记录时会触发
            function select(e) {
                if (e.poi && e.poi.location) {
                    map.setZoom(15);
                    map.setCenter(e.poi.location);
                }
            }
        }

        //使用浏览器定位
        this.findPositionByBrowser = function(){
            map.plugin('AMap.Geolocation', function() {
                geolocation = new AMap.Geolocation({
                    enableHighAccuracy: true,//是否使用高精度定位，默认:true
                    timeout: 10000,          //超过10秒后停止定位，默认：无穷大
                    buttonOffset: new AMap.Pixel(10, 20),//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
                    zoomToAccuracy: true,      //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
                    buttonPosition:'RB'
                });
                map.addControl(geolocation);
                geolocation.getCurrentPosition();
                AMap.event.addListener(geolocation, 'complete', onComplete);//返回定位信息
                AMap.event.addListener(geolocation, 'error', onError);      //返回定位出错信息
            });
        }

        this.addMark = function(){
            addMark();
        }

        this.clearMark = function(){
            clearMark();
        }
        this.getMarkPosition = function(){
            return marker.get('position');
        }

        /**
         * 添加一个标记，只有在不存在标记时才会创建
         */
        function addMark(){
            if(!marker){
                log('创建了一个标记');
                marker = new AMap.Marker({
                    icon: "http://webapi.amap.com/theme/v1.3/markers/n/mark_b.png",
                    position: [lon, lat],
                    draggable: true,
                    cursor: 'move',
                    raiseOnDrag: true
                });
                marker.setMap(map);
            }
        }

        function clearMark(){
            if(marker){
                log('清除了标记')
                marker.setMap(null);
                marker = null;
            }
        }

        //解析定位结果
        function onComplete(data) {
            log('定位成功');
            lon = data.position.getLng();
            lat = data.position.getLat();
            addMark();
        }
        //解析定位错误信息
        function onError(data) {
            log('定位失败');
        }


        //获取用户所在城市信息
        function showCityInfo() {
            //实例化城市查询类
            var citysearch = new AMap.CitySearch();
            //自动获取用户IP，返回当前城市
            citysearch.getLocalCity(function(status, result) {
                if (status === 'complete' && result.info === 'OK') {
                    if (result && result.city && result.bounds) {
                        var cityinfo = result.city;
                        var citybounds = result.bounds;
                        document.getElementById('tip').innerHTML = '您当前所在城市：'+cityinfo;
                        //地图显示当前城市
                        map.setBounds(citybounds);
                    }
                } else {
                    document.getElementById('tip').innerHTML = result.info;
                }
            });
        }

        function log(str){
            console.log(str);
        }
    }

    $(window).ready(function(){
        $("[data-mask]").inputmask();

        //选择地图modal
        $('#chooseMapBtn').click(function(){
            $('#chooseMapModal').modal();
        })


        $('#chooseMapModal').on('show.bs.modal',function(){
            if(typeof map=='undefined'){
                map = new aMap();
                map.setContainer('AMap');
                map.init();
                map.findPositionByBrowser();
                $('#autoMark').click(function(){
                    map.clearMark();
                    map.addMark();
                })

                $('#clearMark').click(function(){
                    map.clearMark();
                })
            }else{
                return;
            }
        })
        $('#chooseMapModal').on('hide.bs.modal',function(){
            if(typeof map=='undefined'){
                if(confirm('你还没有选择位置，确定离开？')){
                    $('#chooseMapModal').modal('hide');
                }else{
                    $('#chooseMapModal').modal('show');
                }
            }else{
                log('执行了隐藏');
                var position = map.getMarkPosition();
                //获取位置信息
                $('input[name="lon"]').val(position.lng);
                $('input[name="lat"]').val(position.lat);
                getPlaceFormLonLat(position.lng,position.lat);
            }
        })

        $('input[name="place"]').focus(function(){
            if($(this).val()==''){
                $('#chooseMapModal').modal('show');
            }
        })

        //确定点位置
        $('#surePosition').click(function(){
            if(typeof map=='undefined'){
                if(confirm('你还没有选择位置，确定离开？')){
                    $('#chooseMapModal').modal('hide');
                }else{
                    $('#chooseMapModal').modal('show');
                }
            }else{
                $('#chooseMapModal').modal('hide');
            }
        })


    })

    function log(str){
        console.log(str);
    }

    function geocoder_CallBack(data) {
        var address = data.regeocode.formattedAddress; //返回地址描述
        log(address);
        $('input[name="place"]').val(address);
    }

    function getPlaceFormLonLat(lon,lat){
        var geocoder = new AMap.Geocoder({
            radius: 1000,
            extensions: "all"
        });
        geocoder.getAddress([lon,lat], function(status, result) {
            if (status === 'complete' && result.info === 'OK') {
                geocoder_CallBack(result);
            }
        });
    }

    $(function(){
        //iCheck for checkbox and radio inputs
        $('input[type="checkbox"].minimal, input[type="radio"].minimal').iCheck({
            checkboxClass: 'icheckbox_minimal',
            radioClass: 'iradio_minimal'
        });
        //Red color scheme for iCheck
        $('input[type="checkbox"].minimal-red, input[type="radio"].minimal-red').iCheck({
            checkboxClass: 'icheckbox_minimal-red',
            radioClass: 'iradio_minimal-red'
        });
        //Flat red color scheme for iCheck
        $('input[type="checkbox"].flat-red, input[type="radio"].flat-red').iCheck({
            checkboxClass: 'icheckbox_flat-red',
            radioClass: 'iradio_flat-red'
        });
    })

</script>
